/*!
 * min.diksionariu.com
 * Version: 0.0.1 (fork of diksionariu.com v.40.a)
 * Author: dr²
 * AI: ChatGPT (proofreading, architecture suggestions)
 * License: fully open, no rights reserved, use at your own risk
 * Description: A JavaScript module to plug into webpages
 * 				to interface with the diksionariu.com database
 *				https://diksionariu.com
 *				(CHamoru-English dicionary, expanded from the
 *				Guam Department of CHamoru Affairs Dictionary
 *				overseen by Katherine Aguon, lead editor)
 */
function diksionariu(){var e=this;this.PHP_ref="diksionariu_min.php",this.search_field=document.getElementById("diksionariu-search"),this.results_div=document.getElementById("diksionariu-results"),this.search_bar=document.getElementById("diksionariu-entry"),this.submit_button_CH=document.getElementById("diksionariu-submit-button-CH"),this.submit_button_Eng=document.getElementById("diksionariu-submit-button-Eng"),this.search_bar.addEventListener("keyup",(function(t){"Enter"===t.key&&e.search(e.search_bar.value)})),this.submit_button_CH.addEventListener("click",(function(){e.search(e.search_bar.value)})),this.submit_button_Eng.addEventListener("click",(function(){e.search(e.search_bar.value,"Eng")})),this.results_div.addEventListener("click",(t=>{"A"===t.target.tagName&&t.target.dataset.query&&(t.preventDefault(),e.search_bar.value=t.target.dataset.query,e.search(t.target.dataset.query))}));const t={swap:function(e){if(0==e.length)return this.templates.lineBreak();var t=(e=e.replaceAll("||","§")).split("§"),i=t.shift();0==i.length&&(i="examples");for(var n=0;n<t.length;n++)t[n]=t[n].replaceAll("|","§"),t[n]=t[n].split("§");if(this[i])return this[i](t);throw new Error("Template not found: "+i)},lineBreak:function(){return"<br />"},list:function(e){for(var t="",i=0;i<e.length;i++)t+="<li>"+e[i][0],e[i].length>1&&(t+=" ("+e[i][1]+")"),t+="</li>";return t},examples:function(e){for(var t="",i=0;i<e.length;i++)t+="<div class='ex-ch'>"+e[i][0]+"</div>",e[i].length>1&&(t+="<div class='ex-eng'>"+e[i][1]+"</div>");return t}};this.templates=t}diksionariu.prototype.search=function(e,t="CH"){const i=this;(e=e.trim()).length<1||(e="q="+encodeURIComponent(e)+"&lx="+t,window.XMLHttpRequest&&(xmlhttp=new XMLHttpRequest),xmlhttp.onreadystatechange=function(){if(4==this.readyState&&200==this.status){const e=JSON.parse(this.responseText),t=e.function_name,n=e.query,r=e.data,s=e.param1,l=e.param2;"function"==typeof i[t]?(void 0===s&&void 0===l&&i[t](n,r),void 0!==s&&void 0===l&&i[t](n,r,s),void 0!==s&&void 0!==l&&i[t](n,r,s,l)):this.displayError("Error: Function ["+t+"] is not defined.")}},xmlhttp.open("GET",this.PHP_ref+"?"+e,!0),xmlhttp.setRequestHeader("Content-Type","application/json; charset=utf-8"),xmlhttp.send())},diksionariu.prototype.fuzzySearch=function(e,t,i=!1){var n=[],r="",s=this.extractAllWords(t),l=i?20:10;e=e.replaceAll("~","");for(var a=0;a<s.length;a++)Math.abs(e.length-s[a].length)<4&&n.push([this.levenshtein(s[a],e),s[a]]);n.sort((function(e,t){return e[0]>t[0]?-1:1}));for(a=0;a<Math.min(n.length,l);a++)r+="<div class='fuzzy-match'><div class='match-strength'><div class='match-strength-bar' style='width:"+5*n[a][0]+"em'></div></div><a href='#' data-query=\""+n[a][1]+'">'+n[a][1]+"</a><br /></div>";return r=i?"<div class='fuzzy-container fuzzy-container-columns'>"+r+"</div>":"<div class='fuzzy-container'>"+r+"</div>"},diksionariu.prototype.extractAllWords=function(e){for(var t=[],i=0;i<e.length;i++)for(var n of(t.push(e[i].entry),["alternate_forms","related_forms","see_also"]))for(var r=e[i][n].match(/(\[\[[^\[]*\]\])/g)||[],s=0;s<r.length;s++)r[s]=r[s].slice(2,r[s].indexOf("|")),t.push(r[s].replace("]",""));return Array.from(new Set(t)).sort()},diksionariu.prototype.levenshtein=function(e,t){var i,n,r=[];e=e.replaceAll("'","").replaceAll("ñ","n").replace(/([BCDFGHKLMNPRSTYbcdfghklmnprsty])\1+/g,"$1").toLowerCase(),t=t.replaceAll("'","").replaceAll("ñ","n").replace(/([BCDFGHKLMNPRSTYbcdfghklmnprsty])\1+/g,"$1").toLowerCase();for(var s=0;s<=t.length;s++)for(var l=0;l<=e.length;l++){if(s&&l){var a=e.charAt(s-1),o=t.charAt(l-1),h=[a,o];n=a===o?i:h.includes("a")&&h.includes("å")?i+.1:h.includes("i")&&h.includes("e")||h.includes("i")&&h.includes("u")||h.includes("u")&&h.includes("o")||h.includes("e")&&h.includes("o")?i+.5:h.includes("a")&&h.includes("e")||h.includes("a")&&h.includes("o")||h.includes("å")&&h.includes("o")||h.includes("l")&&h.includes("r")||h.includes("l")&&h.includes("t")||h.includes("r")&&h.includes("t")?i+.8:Math.min(r[l],r[l-1],i)+1}else n=s+l;i=r[l],r[l]=n}return 1-(1-1/(.5+Math.max(e.length,t.length)))*(r.pop()/Math.max(e.length,t.length))},diksionariu.prototype.replaceMarkup=function(e){const t=this;return e=(e=(e=(e=(e=(e=(e=e.replaceAll("''''","'§")).replaceAll("'''","§")).replace(/(§[^§]*§)/g,(function(e){return"<b>"+e.slice(1,-1)+"</b>"}))).replaceAll("~~","§")).replace(/(§[^§]*§)/g,(function(e){return"<i>"+e.slice(1,-1)+"</i>"}))).replace(/(\[\[[^\[]*\]\])/g,(function(e){if(e.includes("|")){var t=e.split("|");return/[A-Za-z0-9]\.[A-Za-z0-9]{2}/.test(t[1])?"<a class='markup-link external' target='_blank' href=\""+t[1].slice(0,-2)+'">'+t[0].slice(2)+"</a>":"<a class='markup-link' href='#' data-query=\""+t[1].slice(0,-2)+'">'+t[0].slice(2)+"</a>"}return"<a class='markup-link' href='#' data-query=\""+e.slice(2,-2)+'">'+e.slice(2,-2)+"</a>"}))).replace(/(\{\{[^\{]*\}\})/g,(function(e){try{return t.templates.swap(e.slice(2,-2))}catch(e){console.error(e.message)}}))},diksionariu.prototype.addHighlights=function(e,t){if(t.includes("*")||t.includes("?")||t.includes("~"))return e;var i=[...e.matchAll(/<[^\<]*>/g)],n=document.createElement("div");n.innerHTML=e,n=n.innerText.normalize("NFD").replace(/[\u0300-\u036f]/g,""),t=t.normalize("NFD").replace(/[\u0300-\u036f]/g,"");for(var r=[...n.toLowerCase().matchAll(new RegExp(t.toLowerCase(),"gi"))].map((e=>[e.index,e.index+e[0].length])),s=0;s<i.length;s++)for(var l=0;l<r.length;l++)i[s].index<=r[l][0]&&(r[l][0]+=i[s][0].length),i[s].index<=r[l][1]&&(r[l][1]+=i[s][0].length);for(s=r.length-1;s>-1;s--)e=(e=e.substring(0,r[s][1])+"</span>"+e.substring(r[s][1],e.length)).substring(0,r[s][0])+"<span class='highlight'>"+e.substring(r[s][0],e.length);return e},diksionariu.prototype.formatSingleResult=function(e,t=!0){var i="",n="",r="",s="",l="",a="",o="",h="",d="",c="";e.examples.length>0&&"{{"!=e.examples.slice(0,2)&&(e.examples="<ul><li><i>"+e.examples+"</i></li></ul>"),e.alternate_forms.length>0&&(i="<h3>Alternate Forms:</h3><div class='entry-field'>"+e.alternate_forms+"</div>"),e.origin.length>0&&(n="<h3>Origin:</h3><div class='entry-field'>"+e.origin+"</div>"),e.part_of_speech.length>0&&(r="<h3 class='part-of-speech'>"+e.part_of_speech+"</h3>"),e.definition.length>0&&(s="<div class='entry-field'>"+e.definition+"</div>"),e.examples.length>0&&(l="<div class='entry-field'>"+e.examples+"</div>"),e.notes.length>0&&(a="<h3>Notes:</h3><div class='entry-field'>"+e.notes+"</div>"),e.related_forms.length>0&&(o="<h3>Related Forms:</h3><div class='entry-field'>"+e.related_forms+"</div>"),e.see_also.length>0&&(h="<h3>See Also:</h3><div class='entry-field'>"+e.see_also+"</div>"),e.source.length>0&&(d="<h3>Source:</h3><div class='entry-field'>"+e.source+"</div>"),(i.length>0||n.length>0||a.length>0||o.length>0||h.length>0||d.length>0)&&(c="<div class='content minor-content'>"+i+n+a+o+h+d+"</div>");var u="";return t&&(u+="<div class='entry'><h1>"+e.entry+"</h1>"),u+="<div class='content'>"+r+s+l+"</div>"+c+"</br></div>",u=this.replaceMarkup(u)},diksionariu.prototype.displayCHResults=function(e,t,i="",n=[]){var r=""+i,s=[],l=[];if("0"==t&&(""==i?r="<h2>"+e+"</h2><p class='no-result'>Entry not found</p></br><h3>Did you mean: </h3>"+this.fuzzySearch(e,n):i.length>0&&(r+=this.fuzzySearch(e,n,!0))),"0"!=t)if(e.indexOf("*")>-1||e.indexOf("?")>-1){r="<div><h2>"+t.length+" results found</h2></div>";for(var a=0;a<t.length;a++)r+=this.formatSingleResult(t[a])}else{for(a=0;a<t.length;a++)t[a].entry==e?s.push(a):l.push(a);for(var o=0;o<s.length;o++){a=s[o];r+=this.formatSingleResult(t[a])}for(o=0;o<l.length;o++){a=l[o];r+=this.formatSingleResult(t[a])}}r="<div class='results-single'>"+r+"</div>",this.results_div.innerHTML=r},diksionariu.prototype.displayCHAltResults=function(e,t){for(var i=[],n=[],r=[],s=0,l=0,a=0;a<t.length;a++)t[a].alternate_forms.includes("[["+e+"]]")&&(s++,l=a);if(1!=s){if(!(e.indexOf("*")>-1||e.indexOf("?")>-1)){for(a=0;a<t.length;a++)t[a].alternate_forms.includes(e)?i.push(t[a]):t[a].related_forms.includes(e)?n.push(t[a]):r.push(t[a]);t=i.concat(n,r)}var o="<h2>"+e+"</h2><p class='no-result'>Entry not found</p><p class='no-result'><a class='no-result-link' href='#' data-query=\""+e+'~">Try fuzzy search? '+e+"~</a><br /><br /></p>";o+="<div><h3>"+t.length+" results in other entries</h3></div>";for(a=0;a<t.length;a++)t[a].alternate_forms=this.replaceMarkup(t[a].alternate_forms.replaceAll("'''","")),t[a].related_forms=this.replaceMarkup(t[a].related_forms.replaceAll("'''","")),t[a].see_also=this.replaceMarkup(t[a].see_also.replaceAll("'''","")),t[a].definition=this.replaceMarkup(t[a].definition);for(a=0;a<t.length;a++)t[a].alternate_forms=this.addHighlights(t[a].alternate_forms,e),t[a].related_forms=this.addHighlights(t[a].related_forms,e),t[a].see_also=this.addHighlights(t[a].see_also,e);for(a=0;a<t.length;a++){var h="",d="",c="";t[a].alternate_forms.length>0&&(h="<p><b>Alternate Forms: </b>"+t[a].alternate_forms+"</p>"),t[a].related_forms.length>0&&(d="<p><b>Related Forms: </b>"+t[a].related_forms+"</p>"),t[a].see_also.length>0&&(c="<p><b>See Also: </b>"+t[a].see_also+"</p>"),o+="<div class='results-english'><h3><a href='#' data-query=\""+t[a].entry+'">'+t[a].entry+"</a></h3><p><b>Part of Speech:</b> "+t[a].part_of_speech+"</p><p><b>Definition:</b> "+t[a].definition+"</p>"+h+d+c+"</div>"}this.results_div.innerHTML="<div class='results-single'>"+o+"</div>"}else{var u="<div class='entry-field redirect-text'>(Redirected from <a href='#' data-query='"+e+"'>"+e+")</a></div>";this.displayCHResults(t[l].entry,[t[l]],u)}},diksionariu.prototype.displayCHPartialResults=function(e,t,i){var n="<h2>"+e+"</h2><p class='no-result'>Entry not found</p>";n+="<div class='partial-container'><div class='partial-subcontainer'><h3>Partial matches</h3><div class='partial-results'>",t.sort(((t,i)=>Math.abs(t.entry.length-e.length)-Math.abs(i.entry.length-e.length)));for(var r=0;r<Math.min(t.length,10);r++){var s="";s=t[r].entry.length>e.length?this.addHighlights(t[r].entry,e):t[r].entry,n+="<div class='partial-match'>• <a href='#' data-query=\""+t[r].entry+'">'+s+"</a></div>"}t.length>10&&(n+="<div class='partial-match'><a href='#' data-query=\"*"+e+'*">See more...</a></div>'),n+="</div></div><div class='partial-subcontainer'><h3>Or did you mean: </h3>"+this.fuzzySearch(e,i)+"</div></div>",this.results_div.innerHTML="<div class='results-single'>"+n+"</div>"},diksionariu.prototype.displayEngResults=function(e,t){var i="",n=[],r=[];if("0"==t)this.results_div.innerHTML="<h2>"+e+"</h2><p class='no-result'>No results found</p><p class='no-result'><a class='no-result-link' href='#' data-query=\""+e+'">Repeat search in CHamoru?</a></p>';else{for(var s=[" ",",",".","?","!",";",":","-","(",")"],l=0;l<t.length;l++){var a=t[l].definition.toLowerCase().indexOf(e.toLowerCase());t[l].definition.length==e.length||0==a&&t[l].definition.length>e.length&&s.includes(t[l].definition[e.length])||a>0&&t[l].definition.length==a+e.length&&s.includes(t[l].definition[a-1])||a>0&&t[l].definition.length>e.length&&s.includes(t[l].definition[a-1])&&s.includes(t[l].definition[a+e.length])?n.push(l):r.push(l)}for(l=0;l<n.length;l++)t[n[l]].definition=this.replaceMarkup(t[n[l]].definition.replaceAll("'''","").replaceAll("~~",""));for(l=0;l<r.length;l++)t[r[l]].definition=this.replaceMarkup(t[r[l]].definition.replaceAll("'''","").replaceAll("~~",""));for(l=0;l<n.length;l++)t[n[l]].definition=this.addHighlights(t[n[l]].definition,e);for(l=0;l<r.length;l++)t[r[l]].definition=this.addHighlights(t[r[l]].definition,e);i="<div><h2>"+t.length+" results found</h2></div>";for(var o=0;o<n.length;o++){i+="<div class='results-english'><h3><a href='#' data-query=\""+t[l=n[o]].entry+'">'+t[l].entry+"</a></h3><p><b>Part of Speech:</b> "+t[l].part_of_speech+"</p><p><b>Definition:</b> "+t[l].definition+"</p></div>"}for(o=0;o<r.length;o++){i+="<div class='results-english'><h3><a href='#' data-query=\""+t[l=r[o]].entry+'">'+t[l].entry+"</a></h3><p><b>Part of Speech:</b> "+t[l].part_of_speech+"</p><p><b>Definition:</b> "+t[l].definition+"</p></div>"}this.results_div.innerHTML="<div class='results-single'>"+i+"</div>"}},diksionariu.prototype.displayError=function(e){this.results_div.innerHTML="<div class='no-result'>Not able to connect to database: </br>"+e+"</div>"};